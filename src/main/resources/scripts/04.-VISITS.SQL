-- TABLE
CREATE TABLE VISITS (
  ID          INT PRIMARY KEY,
  PET_ID      INT NOT NULL,
  VISIT_DATE  DATE,
  DESCRIPTION VARCHAR2(255)
);

ALTER TABLE VISITS ADD CONSTRAINT FK_VISITS_PETS FOREIGN KEY (PET_ID) REFERENCES PETS (ID);
CREATE INDEX VISITS_PET_ID ON VISITS (PET_ID);

-- SEQUENCE
CREATE SEQUENCE VISITS_SEQ START WITH 1;

-- PACKAGE HEADER
CREATE OR REPLACE PACKAGE PKG_VISITS
  AS
  TYPE C_CURSOR IS REF CURSOR;

  PROCEDURE SP_FIND_BY_PET_ID(P_CURSOR OUT C_CURSOR,
                              P_PET_ID IN  VISITS.PET_ID % TYPE);

  PROCEDURE SP_INSERT(P_ID          OUT VISITS.ID % TYPE,
                      P_PET_ID      IN  VISITS.PET_ID % TYPE,
                      P_VISIT_DATE  IN  VISITS.VISIT_DATE % TYPE,
                      P_DESCRIPTION IN  VISITS.DESCRIPTION % TYPE);

  PROCEDURE SP_UPDATE(P_ID          IN VISITS.ID % TYPE,
                      P_PET_ID      IN VISITS.PET_ID % TYPE,
                      P_VISIT_DATE  IN VISITS.VISIT_DATE % TYPE,
                      P_DESCRIPTION IN VISITS.DESCRIPTION % TYPE);

END PKG_VISITS;

-- PACKAGE BODY
CREATE OR REPLACE PACKAGE BODY PKG_VISITS
  AS

  PROCEDURE SP_FIND_BY_PET_ID(P_CURSOR OUT C_CURSOR,
                              P_PET_ID IN  VISITS.PET_ID % TYPE)
    AS
    BEGIN
      OPEN P_CURSOR
      FOR
      SELECT ID,
             PET_ID,
             VISIT_DATE,
             DESCRIPTION
        FROM VISITS
        WHERE PET_ID = P_PET_ID;
    END SP_FIND_BY_PET_ID;

  PROCEDURE SP_INSERT(P_ID          OUT VISITS.ID % TYPE,
                      P_PET_ID      IN  VISITS.PET_ID % TYPE,
                      P_VISIT_DATE  IN  VISITS.VISIT_DATE % TYPE,
                      P_DESCRIPTION IN  VISITS.DESCRIPTION % TYPE)
    AS
    BEGIN
      SELECT VISITS_SEQ.NEXTVAL
        INTO P_ID
        FROM DUAL;
      INSERT INTO VISITS (
        ID, PET_ID, VISIT_DATE, DESCRIPTION
      )
      VALUES (P_ID, P_PET_ID, P_VISIT_DATE, P_DESCRIPTION);
    END SP_INSERT;

  PROCEDURE SP_UPDATE(P_ID          IN VISITS.ID % TYPE,
                      P_PET_ID      IN VISITS.PET_ID % TYPE,
                      P_VISIT_DATE  IN VISITS.VISIT_DATE % TYPE,
                      P_DESCRIPTION IN VISITS.DESCRIPTION % TYPE)
    AS
    BEGIN
      UPDATE VISITS
        SET PET_ID = P_PET_ID, VISIT_DATE = P_VISIT_DATE, DESCRIPTION = P_DESCRIPTION
        WHERE ID = P_ID;
    END SP_UPDATE;

END PKG_VISITS;